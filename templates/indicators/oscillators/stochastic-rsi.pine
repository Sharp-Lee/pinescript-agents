//@version=6
indicator("Stochastic RSI", shorttitle="StochRSI", overlay=false)

// ============================================================================
// INPUTS
// ============================================================================
// RSI Settings
rsiLength = input.int(14, "RSI Length", minval=1, group="RSI Settings")
rsiSource = input.source(close, "RSI Source", group="RSI Settings")

// Stochastic Settings
stochLength = input.int(14, "Stochastic Length", minval=1, group="Stochastic Settings")
kSmooth = input.int(3, "%K Smoothing", minval=1, group="Stochastic Settings")
dSmooth = input.int(3, "%D Smoothing", minval=1, group="Stochastic Settings")

// Levels
oversoldLevel = input.int(20, "Oversold Level", minval=0, maxval=100, group="Levels")
overboughtLevel = input.int(80, "Overbought Level", minval=0, maxval=100, group="Levels")

// Visual Settings
showCrossovers = input.bool(true, "Show K/D Crossovers", group="Visual")
showZones = input.bool(true, "Highlight OB/OS Zones", group="Visual")
fillKD = input.bool(true, "Fill Between K and D", group="Visual")

// Colors
kColor = input.color(color.blue, "%K Color", group="Colors")
dColor = input.color(color.orange, "%D Color", group="Colors")
bullColor = input.color(color.green, "Bullish Color", group="Colors")
bearColor = input.color(color.red, "Bearish Color", group="Colors")

// ============================================================================
// CALCULATIONS
// ============================================================================
// RSI
rsi = ta.rsi(rsiSource, rsiLength)

// Stochastic of RSI
stochRsi = (rsi - ta.lowest(rsi, stochLength)) / (ta.highest(rsi, stochLength) - ta.lowest(rsi, stochLength)) * 100
k = ta.sma(stochRsi, kSmooth)
d = ta.sma(k, dSmooth)

// Crossovers
bullCross = ta.crossover(k, d)
bearCross = ta.crossunder(k, d)

// Zone detection
inOversold = k < oversoldLevel and d < oversoldLevel
inOverbought = k > overboughtLevel and d > overboughtLevel

// Divergence detection (simplified)
priceLow = ta.lowest(low, 5)
priceHigh = ta.highest(high, 5)
stochLow = ta.lowest(k, 5)
stochHigh = ta.highest(k, 5)

// ============================================================================
// PLOTS
// ============================================================================
// K and D lines
kPlot = plot(k, "%K", color=kColor, linewidth=2)
dPlot = plot(d, "%D", color=dColor, linewidth=1)

// Fill between K and D
fillColor = k > d ? color.new(bullColor, 80) : color.new(bearColor, 80)
fill(kPlot, dPlot, color=fillKD ? fillColor : na, title="K/D Fill")

// Level lines
h1 = hline(oversoldLevel, "Oversold", color=color.green, linestyle=hline.style_dashed)
h2 = hline(overboughtLevel, "Overbought", color=color.red, linestyle=hline.style_dashed)
hline(50, "Middle", color=color.gray, linestyle=hline.style_dotted)
fill(h1, h2, color=color.new(color.purple, 95), title="Band Fill")

// Zone backgrounds
bgcolor(showZones and inOversold ? color.new(bullColor, 90) : na, title="Oversold Zone")
bgcolor(showZones and inOverbought ? color.new(bearColor, 90) : na, title="Overbought Zone")

// Crossover signals
plotshape(showCrossovers and bullCross ? k : na, "Bullish Cross", style=shape.triangleup, location=location.absolute, color=bullColor, size=size.small)
plotshape(showCrossovers and bearCross ? k : na, "Bearish Cross", style=shape.triangledown, location=location.absolute, color=bearColor, size=size.small)

// Special signals: crossover in extreme zones
plotshape(showCrossovers and bullCross and k < oversoldLevel ? k : na, "OS Bullish Cross", style=shape.labelup, location=location.absolute, color=bullColor, text="OS", textcolor=color.white, size=size.tiny)
plotshape(showCrossovers and bearCross and k > overboughtLevel ? k : na, "OB Bearish Cross", style=shape.labeldown, location=location.absolute, color=bearColor, text="OB", textcolor=color.white, size=size.tiny)

// ============================================================================
// INFO TABLE
// ============================================================================
var table infoTable = table.new(position.top_right, 2, 4, bgcolor=color.new(color.black, 80))
if barstate.islast
    table.cell(infoTable, 0, 0, "%K", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, str.tostring(k, "#.##"), text_color=kColor, text_size=size.small)
    table.cell(infoTable, 0, 1, "%D", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(d, "#.##"), text_color=dColor, text_size=size.small)
    table.cell(infoTable, 0, 2, "RSI", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 2, str.tostring(rsi, "#.##"), text_color=color.white, text_size=size.small)
    table.cell(infoTable, 0, 3, "Zone", text_color=color.white, text_size=size.small)
    zoneText = inOversold ? "OVERSOLD" : inOverbought ? "OVERBOUGHT" : "NEUTRAL"
    zoneColor = inOversold ? bullColor : inOverbought ? bearColor : color.gray
    table.cell(infoTable, 1, 3, zoneText, text_color=zoneColor, text_size=size.small)

// ============================================================================
// ALERTS
// ============================================================================
alertcondition(bullCross, "Bullish Cross", "StochRSI %K crossed above %D")
alertcondition(bearCross, "Bearish Cross", "StochRSI %K crossed below %D")
alertcondition(bullCross and k < oversoldLevel, "Oversold Bullish Cross", "StochRSI bullish cross in oversold zone")
alertcondition(bearCross and k > overboughtLevel, "Overbought Bearish Cross", "StochRSI bearish cross in overbought zone")
alertcondition(ta.crossover(k, oversoldLevel), "Exit Oversold", "StochRSI exiting oversold zone")
alertcondition(ta.crossunder(k, overboughtLevel), "Exit Overbought", "StochRSI exiting overbought zone")
