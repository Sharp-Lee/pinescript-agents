//@version=6
indicator("OBV with Divergence", shorttitle="OBV Div", overlay=false)

// ============================================================================
// INPUTS
// ============================================================================
// OBV Settings
showMA = input.bool(true, "Show OBV MA", group="OBV Settings")
maLength = input.int(20, "MA Length", minval=1, group="OBV Settings")
maType = input.string("EMA", "MA Type", options=["SMA", "EMA", "WMA"], group="OBV Settings")

// Divergence Settings
pivotLookback = input.int(5, "Pivot Lookback", minval=1, group="Divergence")
maxBars = input.int(50, "Max Lookback Bars", minval=10, group="Divergence")

// Visual Settings
showDivergence = input.bool(true, "Show Divergence", group="Visual")
showHistogram = input.bool(false, "Show as Histogram", group="Visual")
normalizeOBV = input.bool(false, "Normalize OBV", group="Visual", tooltip="Scale OBV to percentage")

// Colors
obvColor = input.color(color.blue, "OBV Color", group="Colors")
maColor = input.color(color.orange, "MA Color", group="Colors")
bullDivColor = input.color(color.green, "Bullish Div", group="Colors")
bearDivColor = input.color(color.red, "Bearish Div", group="Colors")

// ============================================================================
// CALCULATIONS
// ============================================================================
// OBV calculation
obv = ta.cum(math.sign(ta.change(close)) * volume)

// Normalized OBV (optional)
obvNorm = normalizeOBV ? (obv - ta.lowest(obv, 100)) / (ta.highest(obv, 100) - ta.lowest(obv, 100)) * 100 : obv

// OBV Moving Average
obvMA = switch maType
    "SMA" => ta.sma(obvNorm, maLength)
    "EMA" => ta.ema(obvNorm, maLength)
    "WMA" => ta.wma(obvNorm, maLength)

// OBV momentum (rate of change)
obvMomentum = ta.change(obvNorm, 5)

// Pivot detection for divergence
pivotLow = ta.pivotlow(obvNorm, pivotLookback, pivotLookback)
pivotHigh = ta.pivothigh(obvNorm, pivotLookback, pivotLookback)

// Divergence detection
_inRange(cond, maxLen) =>
    bars = ta.barssince(cond)
    bars >= pivotLookback and bars <= maxLen

// Bullish divergence: Price lower low, OBV higher low
bullDiv = showDivergence and pivotLow and _inRange(pivotLow[1], maxBars) and obvNorm[pivotLookback] > ta.valuewhen(pivotLow, obvNorm[pivotLookback], 1) and low[pivotLookback] < ta.valuewhen(pivotLow, low[pivotLookback], 1)

// Bearish divergence: Price higher high, OBV lower high
bearDiv = showDivergence and pivotHigh and _inRange(pivotHigh[1], maxBars) and obvNorm[pivotLookback] < ta.valuewhen(pivotHigh, obvNorm[pivotLookback], 1) and high[pivotLookback] > ta.valuewhen(pivotHigh, high[pivotLookback], 1)

// Trend detection
obvUptrend = obvNorm > obvMA
obvDowntrend = obvNorm < obvMA

// ============================================================================
// PLOTS
// ============================================================================
// OBV Line or Histogram
plot(showHistogram ? na : obvNorm, "OBV", color=obvColor, linewidth=2)
plot(showHistogram ? obvNorm : na, "OBV Histogram", color=obvNorm > obvMA ? color.new(bullDivColor, 50) : color.new(bearDivColor, 50), style=plot.style_columns)

// MA
plot(showMA ? obvMA : na, "OBV MA", color=maColor, linewidth=1)

// Zero line (for normalized)
hline(normalizeOBV ? 50 : 0, "Zero", color=color.gray, linestyle=hline.style_dotted)

// Divergence markers
plotshape(bullDiv ? obvNorm[pivotLookback] : na, "Bullish Div", style=shape.labelup, location=location.absolute, color=bullDivColor, text="Bull", textcolor=color.white, offset=-pivotLookback, size=size.small)
plotshape(bearDiv ? obvNorm[pivotLookback] : na, "Bearish Div", style=shape.labeldown, location=location.absolute, color=bearDivColor, text="Bear", textcolor=color.white, offset=-pivotLookback, size=size.small)

// Background
bgcolor(obvUptrend ? color.new(bullDivColor, 95) : color.new(bearDivColor, 95), title="Trend Background")

// ============================================================================
// INFO TABLE
// ============================================================================
var table infoTable = table.new(position.top_right, 2, 4, bgcolor=color.new(color.black, 80))
if barstate.islast
    table.cell(infoTable, 0, 0, "OBV", text_color=color.white, text_size=size.small)
    obvDisplay = normalizeOBV ? str.tostring(obvNorm, "#.##") : str.tostring(obv / 1000000, "#.##") + "M"
    table.cell(infoTable, 1, 0, obvDisplay, text_color=obvColor, text_size=size.small)
    table.cell(infoTable, 0, 1, "Trend", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 1, obvUptrend ? "BULLISH" : "BEARISH", text_color=obvUptrend ? bullDivColor : bearDivColor, text_size=size.small)
    table.cell(infoTable, 0, 2, "Momentum", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 2, obvMomentum > 0 ? "Rising" : "Falling", text_color=obvMomentum > 0 ? bullDivColor : bearDivColor, text_size=size.small)
    table.cell(infoTable, 0, 3, "vs MA", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 3, obvNorm > obvMA ? "Above" : "Below", text_color=obvNorm > obvMA ? bullDivColor : bearDivColor, text_size=size.small)

// ============================================================================
// ALERTS
// ============================================================================
alertcondition(bullDiv, "Bullish Divergence", "OBV Bullish Divergence detected")
alertcondition(bearDiv, "Bearish Divergence", "OBV Bearish Divergence detected")
alertcondition(ta.crossover(obvNorm, obvMA), "OBV Cross Above MA", "OBV crossed above its moving average")
alertcondition(ta.crossunder(obvNorm, obvMA), "OBV Cross Below MA", "OBV crossed below its moving average")
