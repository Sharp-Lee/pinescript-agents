//@version=6
indicator("Volume Profile (Session)", shorttitle="VP", overlay=true, max_boxes_count=500, max_lines_count=500)

// ============================================================================
// INPUTS
// ============================================================================
// Profile Settings
rowCount = input.int(24, "Number of Rows", minval=10, maxval=100, group="Profile Settings", tooltip="Number of price levels in the profile")
valueAreaPercent = input.float(70.0, "Value Area %", minval=50.0, maxval=100.0, group="Profile Settings", tooltip="Percentage of volume for Value Area")

// Session Settings
sessionType = input.string("Daily", "Session Type", options=["Daily", "Weekly", "Custom"], group="Session", tooltip="Type of session to analyze")
customBars = input.int(100, "Custom Bars", minval=10, group="Session", tooltip="Number of bars for custom session")

// Visual Settings
showPOC = input.bool(true, "Show POC", group="Visual", tooltip="Point of Control - highest volume price")
showVAH = input.bool(true, "Show VAH", group="Visual", tooltip="Value Area High")
showVAL = input.bool(true, "Show VAL", group="Visual", tooltip="Value Area Low")
showProfile = input.bool(true, "Show Volume Bars", group="Visual")
profilePlacement = input.string("Right", "Profile Placement", options=["Left", "Right"], group="Visual")

// Colors
buyColor = input.color(color.new(color.green, 40), "Buy Volume", group="Colors")
sellColor = input.color(color.new(color.red, 40), "Sell Volume", group="Colors")
pocColor = input.color(color.yellow, "POC Color", group="Colors")
vaColor = input.color(color.blue, "Value Area Color", group="Colors")

// ============================================================================
// SESSION DETECTION
// ============================================================================
isNewSession = switch sessionType
    "Daily" => ta.change(time("D")) != 0
    "Weekly" => ta.change(time("W")) != 0
    "Custom" => bar_index % customBars == 0

// ============================================================================
// CALCULATIONS
// ============================================================================
var float sessionHigh = high
var float sessionLow = low
var float[] volumeAtPrice = array.new_float(rowCount, 0.0)
var float[] buyVolAtPrice = array.new_float(rowCount, 0.0)
var float[] sellVolAtPrice = array.new_float(rowCount, 0.0)
var int sessionStartBar = bar_index

// Reset on new session
if isNewSession
    sessionHigh := high
    sessionLow := low
    sessionStartBar := bar_index
    for i = 0 to rowCount - 1
        array.set(volumeAtPrice, i, 0.0)
        array.set(buyVolAtPrice, i, 0.0)
        array.set(sellVolAtPrice, i, 0.0)

// Update session high/low
sessionHigh := math.max(sessionHigh, high)
sessionLow := math.min(sessionLow, low)

// Calculate row height
rowHeight = (sessionHigh - sessionLow) / rowCount

// Distribute volume to rows
if rowHeight > 0
    // Determine buy/sell volume (simplified: close > open = buy)
    isBuyBar = close > open
    barVol = volume
    buyVol = isBuyBar ? barVol : barVol * 0.4
    sellVol = isBuyBar ? barVol * 0.4 : barVol

    // Find which rows the bar spans
    lowRow = math.floor((low - sessionLow) / rowHeight)
    highRow = math.floor((high - sessionLow) / rowHeight)
    lowRow := math.max(0, math.min(lowRow, rowCount - 1))
    highRow := math.max(0, math.min(highRow, rowCount - 1))

    // Distribute volume across rows
    rowsSpanned = highRow - lowRow + 1
    volPerRow = barVol / rowsSpanned
    buyPerRow = buyVol / rowsSpanned
    sellPerRow = sellVol / rowsSpanned

    for i = lowRow to highRow
        array.set(volumeAtPrice, i, array.get(volumeAtPrice, i) + volPerRow)
        array.set(buyVolAtPrice, i, array.get(buyVolAtPrice, i) + buyPerRow)
        array.set(sellVolAtPrice, i, array.get(sellVolAtPrice, i) + sellPerRow)

// Find POC (Point of Control)
var int pocRow = 0
var float maxVol = 0.0
maxVol := 0.0
for i = 0 to rowCount - 1
    vol = array.get(volumeAtPrice, i)
    if vol > maxVol
        maxVol := vol
        pocRow := i

pocPrice = sessionLow + (pocRow + 0.5) * rowHeight

// Calculate Value Area
totalVolume = array.sum(volumeAtPrice)
targetVolume = totalVolume * valueAreaPercent / 100

var int vahRow = pocRow
var int valRow = pocRow
var float vaVolume = array.get(volumeAtPrice, pocRow)

// Expand from POC until value area is reached
while vaVolume < targetVolume and (vahRow < rowCount - 1 or valRow > 0)
    upperVol = vahRow < rowCount - 1 ? array.get(volumeAtPrice, vahRow + 1) : 0
    lowerVol = valRow > 0 ? array.get(volumeAtPrice, valRow - 1) : 0

    if upperVol >= lowerVol and vahRow < rowCount - 1
        vahRow += 1
        vaVolume += upperVol
    else if valRow > 0
        valRow -= 1
        vaVolume += lowerVol
    else
        break

vahPrice = sessionLow + (vahRow + 1) * rowHeight
valPrice = sessionLow + valRow * rowHeight

// ============================================================================
// DRAWING
// ============================================================================
var box[] profileBoxes = array.new_box()
var line pocLine = na
var line vahLine = na
var line valLine = na

// Clear previous drawings
if barstate.islast
    for bx in profileBoxes
        box.delete(bx)
    array.clear(profileBoxes)
    line.delete(pocLine)
    line.delete(vahLine)
    line.delete(valLine)

    // Draw volume profile
    if showProfile and maxVol > 0
        profileWidth = bar_index - sessionStartBar
        maxWidth = math.max(profileWidth * 0.3, 10)

        for i = 0 to rowCount - 1
            vol = array.get(volumeAtPrice, i)
            buyV = array.get(buyVolAtPrice, i)
            sellV = array.get(sellVolAtPrice, i)

            if vol > 0
                rowBottom = sessionLow + i * rowHeight
                rowTop = rowBottom + rowHeight
                barWidth = vol / maxVol * maxWidth

                // Position based on placement
                leftX = profilePlacement == "Right" ? bar_index + 5 : sessionStartBar - int(barWidth) - 5
                rightX = profilePlacement == "Right" ? bar_index + 5 + int(barWidth) : sessionStartBar - 5

                // Draw buy portion
                buyWidth = buyV / vol * barWidth
                if buyV > 0
                    buyLeft = profilePlacement == "Right" ? leftX : rightX - int(buyWidth)
                    buyRight = profilePlacement == "Right" ? leftX + int(buyWidth) : rightX
                    array.push(profileBoxes, box.new(buyLeft, rowTop, buyRight, rowBottom, border_color=na, bgcolor=buyColor))

                // Draw sell portion
                sellWidth = sellV / vol * barWidth
                if sellV > 0
                    sellLeft = profilePlacement == "Right" ? leftX + int(buyWidth) : leftX
                    sellRight = profilePlacement == "Right" ? rightX : leftX + int(sellWidth)
                    array.push(profileBoxes, box.new(sellLeft, rowTop, sellRight, rowBottom, border_color=na, bgcolor=sellColor))

    // Draw POC line
    if showPOC
        pocLine := line.new(sessionStartBar, pocPrice, bar_index + 50, pocPrice, color=pocColor, width=2, style=line.style_solid, extend=extend.none)

    // Draw Value Area lines
    if showVAH
        vahLine := line.new(sessionStartBar, vahPrice, bar_index + 50, vahPrice, color=vaColor, width=1, style=line.style_dashed, extend=extend.none)

    if showVAL
        valLine := line.new(sessionStartBar, valPrice, bar_index + 50, valPrice, color=vaColor, width=1, style=line.style_dashed, extend=extend.none)

// ============================================================================
// PLOTS (for alerts)
// ============================================================================
plot(pocPrice, "POC", color=color.new(pocColor, 100), display=display.none)
plot(vahPrice, "VAH", color=color.new(vaColor, 100), display=display.none)
plot(valPrice, "VAL", color=color.new(vaColor, 100), display=display.none)

// ============================================================================
// INFO TABLE
// ============================================================================
var table infoTable = table.new(position.top_right, 2, 5, bgcolor=color.new(color.black, 80))
if barstate.islast
    table.cell(infoTable, 0, 0, "POC", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, str.tostring(pocPrice, "#.####"), text_color=pocColor, text_size=size.small)
    table.cell(infoTable, 0, 1, "VAH", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(vahPrice, "#.####"), text_color=vaColor, text_size=size.small)
    table.cell(infoTable, 0, 2, "VAL", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 2, str.tostring(valPrice, "#.####"), text_color=vaColor, text_size=size.small)
    table.cell(infoTable, 0, 3, "VA Range", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 3, str.tostring((vahPrice - valPrice) / pocPrice * 100, "#.##") + "%", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 0, 4, "Price vs POC", text_color=color.white, text_size=size.small)
    distFromPOC = (close - pocPrice) / pocPrice * 100
    table.cell(infoTable, 1, 4, str.tostring(distFromPOC, "#.##") + "%", text_color=distFromPOC > 0 ? color.green : color.red, text_size=size.small)

// ============================================================================
// ALERTS
// ============================================================================
alertcondition(ta.crossover(close, pocPrice), "Price Cross Above POC", "Price crossed above Point of Control")
alertcondition(ta.crossunder(close, pocPrice), "Price Cross Below POC", "Price crossed below Point of Control")
alertcondition(ta.crossover(close, vahPrice), "Price Cross Above VAH", "Price crossed above Value Area High")
alertcondition(ta.crossunder(close, valPrice), "Price Cross Below VAL", "Price crossed below Value Area Low")
alertcondition(close > valPrice and close < vahPrice, "Price Inside Value Area", "Price is inside the Value Area")
