//@version=6
indicator("ATR Bands / Keltner Channel", shorttitle="ATR Bands", overlay=true)

// ============================================================================
// INPUTS
// ============================================================================
// Channel Settings
length = input.int(20, "Length", minval=1, group="Channel Settings", tooltip="Period for moving average")
atrLength = input.int(10, "ATR Length", minval=1, group="Channel Settings", tooltip="Period for ATR calculation")
multiplier1 = input.float(1.0, "Inner Band Multiplier", minval=0.1, step=0.1, group="Channel Settings")
multiplier2 = input.float(2.0, "Outer Band Multiplier", minval=0.1, step=0.1, group="Channel Settings")

// MA Type
maType = input.string("EMA", "MA Type", options=["EMA", "SMA", "WMA", "HMA"], group="Channel Settings")

// Visual Settings
showInnerBands = input.bool(true, "Show Inner Bands", group="Visual")
showOuterBands = input.bool(true, "Show Outer Bands", group="Visual")
showFill = input.bool(true, "Show Band Fill", group="Visual")
showBreakouts = input.bool(true, "Show Breakout Signals", group="Visual")

// Colors
basisColor = input.color(color.blue, "Basis Color", group="Colors")
innerColor = input.color(color.orange, "Inner Band Color", group="Colors")
outerColor = input.color(color.red, "Outer Band Color", group="Colors")

// ============================================================================
// FUNCTIONS
// ============================================================================
ma(src, len, type) =>
    switch type
        "EMA" => ta.ema(src, len)
        "SMA" => ta.sma(src, len)
        "WMA" => ta.wma(src, len)
        "HMA" => ta.hma(src, len)

// ============================================================================
// CALCULATIONS
// ============================================================================
// Basis (middle line)
basis = ma(close, length, maType)

// ATR for band width
atr = ta.atr(atrLength)

// Inner bands
innerUpper = basis + atr * multiplier1
innerLower = basis - atr * multiplier1

// Outer bands
outerUpper = basis + atr * multiplier2
outerLower = basis - atr * multiplier2

// Breakout detection
breakoutUp = ta.crossover(close, outerUpper)
breakoutDown = ta.crossunder(close, outerLower)

// Mean reversion signals (touch inner band and return)
touchInnerUpper = high >= innerUpper and close < innerUpper
touchInnerLower = low <= innerLower and close > innerLower

// Band width (volatility measure)
bandWidth = (outerUpper - outerLower) / basis * 100

// Position within bands
position = (close - outerLower) / (outerUpper - outerLower) * 100

// ============================================================================
// PLOTS
// ============================================================================
// Basis
plot(basis, "Basis", color=basisColor, linewidth=2)

// Inner bands
p1 = plot(showInnerBands ? innerUpper : na, "Inner Upper", color=innerColor, linewidth=1)
p2 = plot(showInnerBands ? innerLower : na, "Inner Lower", color=innerColor, linewidth=1)

// Outer bands
p3 = plot(showOuterBands ? outerUpper : na, "Outer Upper", color=outerColor, linewidth=1)
p4 = plot(showOuterBands ? outerLower : na, "Outer Lower", color=outerColor, linewidth=1)

// Fill between bands
fill(p1, p2, color=showFill ? color.new(innerColor, 90) : na, title="Inner Fill")
fill(p3, p1, color=showFill ? color.new(outerColor, 95) : na, title="Upper Outer Fill")
fill(p2, p4, color=showFill ? color.new(outerColor, 95) : na, title="Lower Outer Fill")

// Breakout signals
plotshape(showBreakouts and breakoutUp ? outerUpper : na, "Breakout Up", style=shape.triangleup, location=location.absolute, color=color.green, size=size.small)
plotshape(showBreakouts and breakoutDown ? outerLower : na, "Breakout Down", style=shape.triangledown, location=location.absolute, color=color.red, size=size.small)

// Mean reversion signals
plotshape(showBreakouts and touchInnerUpper ? high : na, "Touch Upper", style=shape.xcross, location=location.absolute, color=color.orange, size=size.tiny)
plotshape(showBreakouts and touchInnerLower ? low : na, "Touch Lower", style=shape.xcross, location=location.absolute, color=color.orange, size=size.tiny)

// ============================================================================
// INFO TABLE
// ============================================================================
var table infoTable = table.new(position.top_right, 2, 5, bgcolor=color.new(color.black, 80))
if barstate.islast
    table.cell(infoTable, 0, 0, "ATR", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, str.tostring(atr, "#.####"), text_color=color.white, text_size=size.small)
    table.cell(infoTable, 0, 1, "Band Width", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(bandWidth, "#.##") + "%", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 0, 2, "Position", text_color=color.white, text_size=size.small)
    posColor = position > 80 ? color.red : position < 20 ? color.green : color.white
    table.cell(infoTable, 1, 2, str.tostring(position, "#.#") + "%", text_color=posColor, text_size=size.small)
    table.cell(infoTable, 0, 3, "Upper Band", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 3, str.tostring(outerUpper, "#.####"), text_color=outerColor, text_size=size.small)
    table.cell(infoTable, 0, 4, "Lower Band", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 4, str.tostring(outerLower, "#.####"), text_color=outerColor, text_size=size.small)

// ============================================================================
// ALERTS
// ============================================================================
alertcondition(breakoutUp, "Breakout Up", "Price broke above outer upper band")
alertcondition(breakoutDown, "Breakout Down", "Price broke below outer lower band")
alertcondition(ta.crossover(close, basis), "Cross Above Basis", "Price crossed above basis line")
alertcondition(ta.crossunder(close, basis), "Cross Below Basis", "Price crossed below basis line")
alertcondition(touchInnerUpper, "Touch Inner Upper", "Price touched inner upper band")
alertcondition(touchInnerLower, "Touch Inner Lower", "Price touched inner lower band")
